---
import PageLayout from '../layouts/BaseLayout.astro'
import { Icon } from 'astro-icon/components'

import { Image } from 'astro:assets'
import profile from '../assets/profile.jpg'

import fs from 'fs'
import yaml from 'js-yaml'
import path from 'path'

// Load social links
const socialLinksYaml = fs.readFileSync(
	path.join(process.cwd(), 'src/data/social-links.yaml'),
	'utf8'
)
const socialData = yaml.load(socialLinksYaml) as {
	socialLinks: Array<{ name: string; url: string; icon: string; label: string }>
}
const socialLinks = socialData.socialLinks

// Load projects
import { getLiveProjects, getProjectsByStatus } from '../../packages/shared/src/lib/projects'
import { getAllProjects } from '../../packages/shared/src/data/projectLoader'
import ProjectCard from '../../packages/shared/src/components/ProjectCard.astro'
import Timeline from '../../packages/shared/src/components/Timeline.astro'

// Load Substack posts
import { getSubstackPosts } from '../../packages/shared/src/lib/substack'
import SubstackPostPreview from '../../packages/shared/src/components/SubstackPostPreview.astro'
import substackMappingsRaw from '../../packages/shared/src/data/substack-posts.yaml?raw'

const SUBSTACK_RSS_URL = 'https://0to1datascience.substack.com/feed'
const allSubstackPosts = await getSubstackPosts(SUBSTACK_RSS_URL, substackMappingsRaw)
const recentSubstackPosts = allSubstackPosts.slice(0, 5)

const allProjects = getAllProjects()
const liveProjects = getLiveProjects(allProjects)
const inProgressProjects = getProjectsByStatus(allProjects, 'in-progress')
const activeProjects = [...liveProjects, ...inProgressProjects] // Cards for live + in-progress
const upcomingProjects = getProjectsByStatus(allProjects, 'coming-soon')
---

<PageLayout meta={{ title: 'Home' }}>
	<div class='w-full'>

		<!-- ============================================ -->
		<!-- HERO: Compact horizontal card                -->
		<!-- ============================================ -->
			<section class='border border-border bg-primary-foreground p-4 sm:p-6 shadow-lg shadow-black/5'>
				<div class='flex flex-col items-center gap-6 sm:flex-row sm:items-start'>
					<!-- Profile Image -->
					<Image
						src={profile}
						alt='profile photo'
						class='h-28 w-28 shrink-0 rounded-full bg-[#FFBE98] p-1.5'
						loading='eager'
					/>

					<!-- Name + Tagline + Socials -->
					<div class='flex flex-col items-center gap-4 sm:items-start'>
						<div class='text-center sm:text-left'>
							<h1 class='text-2xl font-bold sm:text-3xl'>Eeshan Srivastava</h1>
							<p class='mt-1 text-lg text-muted-foreground'>
							Engineer x Data Scientist x Leader
						</p>
						<!-- Social Links + Newsletter -->
						<div class='flex flex-wrap items-center gap-x-3 gap-y-3'>
							{
								socialLinks.map((link) => (
									<a
										href={link.url}
										target='_blank'
										class='flex h-9 w-9 items-center justify-center rounded-full border border-border bg-background transition-all hover:bg-input'
										aria-label={link.label}
									>
										<Icon name={link.icon} class='h-4 w-4' />
									</a>
								))
							}
							<span class='text-muted-foreground'>|</span>
							<a
							href='https://0to1datascience.substack.com'
								target='_blank'
								class='group flex items-center gap-2 text-sm'
							>
								<Icon name='simple-icons:substack' class='h-4 w-4 shrink-0' />
								<span class='text-muted-foreground'>Newsletter</span>
								<span class='font-medium text-foreground transition group-hover:translate-x-0.5'>Follow →</span>
							</a>
						</div>
					</div>
				</div>
			</section>

			<!-- ============================================ -->
			<!-- PHILOSOPHY                                   -->
			<!-- ============================================ -->
			<section class='mt-8 sm:mt-10 border-l-2 border-amber-400 pl-4 sm:pl-6 space-y-4'>
				<!-- Section heading with tight tracking -->
			<h2 class='text-xl sm:text-2xl font-bold text-foreground tracking-tight'><span class='font-serif italic text-amber-700 dark:text-amber-400'>0→1 Data Science.</span> From applications to analysis.</h2>
				<!-- Subtle divider -->
				<div class='border-t border-border/50 pt-2'>
					<p class='text-base text-muted-foreground'>
						AI is changing how we build software. <span class='italic bg-amber-200/60 dark:bg-amber-400/25 px-1'>I'm exploring what this means for full-stack data science workflows.</span> I love what I get to do for work - leading data science teams, projects that reach millions of customers and influence real business decisions. I'm also too curious about what's coming next, so I explore in my free time.  
					</p>
					<p class='text-base text-muted-foreground mt-2'>
						I built this learning lab to practice <span class='italic bg-amber-200/60 dark:bg-amber-400/25 px-1'>the full 0→1 loop</span>—prototype an app, wire up analytics, watch real users, analyze the data, and publish what I learn. The stack is Astro (static-first with React islands), PostHog (analytics + feature flags), Supabase (Postgres + real-time API), and Python notebooks for statistical analysis—all wired together with automated pipelines, to make it easier to build more web apps on top.
					</p>
					<p class='text-base text-muted-foreground mt-2'>
						Everything is <a href='https://github.com/eeshansrivastava89/datascienceapps' target='_blank' rel='noopener noreferrer' class='underline hover:text-foreground'>open source</a> and non-commercial. Check out a <a href='/ab-simulator/' class='underline hover:text-foreground'>live experiment</a> or the <a href='/analysis?project=ab-simulator' class='underline hover:text-foreground'>analysis</a>. If you learn by building too, feel free to <a href='https://0to1datascience.substack.com' target='_blank' rel='noopener noreferrer' class='underline hover:text-foreground'>follow along</a> or <a href='https://github.com/eeshansrivastava89/datascienceapps/blob/main/docs/CONTRIBUTING.md' target='_blank' rel='noopener noreferrer' class='underline hover:text-foreground'>contribute</a>.
					</p>
				</div>
			</section>

			<!-- ============================================ -->
			<!-- PROJECTS                                     -->
			<!-- ============================================ -->
			<section class='mt-8 sm:mt-10 space-y-4'>
				<h2 class='text-xl sm:text-2xl font-bold text-foreground'>Projects</h2>
				<p class='text-base text-muted-foreground'>Each app applies a data science method to a real problem. Interact, contribute data, and explore the published analysis.</p>
				<div class='space-y-3'>
					{activeProjects.map((project) => (
						<ProjectCard project={project} variant='compact' />
					))}
				</div>
				
				<!-- What's Next Timeline (coming-soon only) -->
				{upcomingProjects.length > 0 && (
					<div class='mt-6'>
						<Timeline 
							inProgressProjects={[]} 
							upcomingProjects={upcomingProjects} 
						/>
					</div>
				)}
			</section>

			<!-- ============================================ -->
			<!-- RECENT SUBSTACK POSTS                        -->
			<!-- ============================================ -->
			<section class='mt-8 sm:mt-10 space-y-4'>
				<h2 class='text-xl sm:text-2xl font-bold text-foreground'>Recent Substack Posts</h2>
				{recentSubstackPosts.length > 0 ? (
					<ul class='flex flex-col gap-y-3 list-none p-0 m-0'>
						{recentSubstackPosts.map((post) => (
							<SubstackPostPreview post={post} withDesc />
						))}
					</ul>
				) : (
					<p class='text-muted-foreground'>No posts yet.</p>
				)}
				<a
					href='/analysis'
					class='inline-block text-sm text-muted-foreground hover:text-foreground transition'
				>
					View all posts →
				</a>
			</section>

			<!-- ============================================ -->
			<!-- NEWSLETTER SIGNUP                            -->
			<!-- Opens Substack with email pre-filled         -->
			<!-- ============================================ -->
			<section class='mt-8 sm:mt-10'>
				<div class='border border-border bg-primary-foreground p-4 sm:p-8'>
					<div class='flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between'>
						<div class='flex items-start gap-3'>
							<Icon name='simple-icons:substack' class='h-6 w-6 mt-0.5 shrink-0 text-[#FF6719]' />
							<div class='space-y-1'>
								<h2 class='text-xl font-bold text-foreground'>Subscribe for updates</h2>
							<p class='text-sm text-muted-foreground'>Updates from 0→1 data science. What works, what breaks, what I'm learning.</p>
							</div>
						</div>
						<form 
							class='flex w-full gap-2 sm:w-auto'
							id="newsletter-form"
						onsubmit="event.preventDefault(); const email = this.email.value; if(email) window.open('https://0to1datascience.substack.com/subscribe?email=' + encodeURIComponent(email), '_blank');"
						>
							<input 
								type="email" 
								name="email" 
								placeholder="you@email.com" 
								required
								class='flex-1 sm:w-64 px-4 py-2.5 text-sm border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-foreground/20 focus:border-foreground transition-all'
							/>
							<button 
								type="submit" 
								class='shrink-0 px-5 py-2.5 text-sm font-medium bg-foreground text-background hover:bg-foreground/90 transition-all hover:-translate-y-0.5'
							>
								Subscribe
							</button>
						</form>
					</div>
				</div>
			</section>

	</div>
</PageLayout>
