---
/**
 * Dynamic Analysis Page for Project Notebooks
 * 
 * Scans analytics/notebooks/{projectId}/*.ipynb for notebooks
 * Embeds rendered HTML from public/analysis/{projectId}/{notebookId}.html
 * 
 * URL pattern: /projects/{projectId}/analysis/{notebookId}
 * Example: /projects/ab-simulator/analysis/ab-test-analysis
 */
import PageLayout from '../../../../layouts/BaseLayout.astro'
import Breadcrumbs from '../../../../../packages/shared/src/components/Breadcrumbs.astro'
import { Icon } from 'astro-icon/components'

import { getAllProjects } from '../../../../../packages/shared/src/data/projectLoader'
import fs from 'node:fs'
import path from 'node:path'

// Generate static paths from folder structure
export async function getStaticPaths() {
  // Inline discovery - scan analytics/notebooks/{projectId}/*.ipynb
  const notebooksDir = path.join(process.cwd(), 'analytics', 'notebooks')
  const notebooks: Array<{ projectId: string; notebookId: string; path: string }> = []
  
  if (fs.existsSync(notebooksDir)) {
    const projectDirs = fs.readdirSync(notebooksDir, { withFileTypes: true })
      .filter(d => d.isDirectory())
      .map(d => d.name)
    
    for (const projectId of projectDirs) {
      const projectPath = path.join(notebooksDir, projectId)
      const ipynbFiles = fs.readdirSync(projectPath)
        .filter(f => f.endsWith('.ipynb'))
      
      for (const file of ipynbFiles) {
        // Convert filename to ID: ab_test_analysis.ipynb -> ab-test-analysis
        const notebookId = file.replace('.ipynb', '').replace(/_/g, '-')
        notebooks.push({
          projectId,
          notebookId,
          path: `analytics/notebooks/${projectId}/${file}`
        })
      }
    }
  }
  
  const allProjects = getAllProjects()
  
  return notebooks.map(nb => {
    const project = allProjects.find(p => p.id === nb.projectId)
    return {
      params: { 
        projectId: nb.projectId, 
        notebookId: nb.notebookId 
      },
      props: { 
        project,
        notebookId: nb.notebookId,
        notebookPath: nb.path
      }
    }
  }).filter(p => p.props.project) // Only include if project exists
}

const { projectId, notebookId } = Astro.params
const { project, notebookPath } = Astro.props
const appUrl = `/${projectId}/`  // Link to actual app page

// Guard - should never happen since getStaticPaths filters undefined projects
if (!project) {
  throw new Error(`Project not found: ${projectId}`)
}

// Derive title from notebook ID: ab-test-analysis -> A/B Test Analysis
function formatTitle(id: string): string {
  return id
    .split('-')
    .map(word => {
      if (word === 'ab') return 'A/B'
      return word.charAt(0).toUpperCase() + word.slice(1)
    })
    .join(' ')
}

const notebookTitle = formatTitle(notebookId)

// Try to load the rendered HTML
let notebookHtml = ''
let lastUpdated = ''
let notebookExists = false

try {
  const htmlPath = path.join(process.cwd(), 'public', 'analysis', projectId, `${notebookId}.html`)
  if (fs.existsSync(htmlPath)) {
    notebookHtml = fs.readFileSync(htmlPath, 'utf-8')
    const stats = fs.statSync(htmlPath)
    // Full datetime format
    lastUpdated = stats.mtime.toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
    notebookExists = true
  }
} catch (e) {
  console.warn(`Notebook HTML not found: ${projectId}/${notebookId}.html`)
}

// Build GitHub link to source notebook
const githubNotebookUrl = `https://github.com/eeshansrivastava89/datascienceapps/blob/main/${notebookPath}`

// Parse refresh schedule from notebooks.yml workflow
let refreshSchedule = 'on demand'
try {
  const workflowPath = path.join(process.cwd(), '.github', 'workflows', 'notebooks.yml')
  if (fs.existsSync(workflowPath)) {
    const workflowContent = fs.readFileSync(workflowPath, 'utf-8')
    const cronMatch = workflowContent.match(/cron:\s*['"](.+?)['"]/)
    if (cronMatch) {
      const cron = cronMatch[1]
      // Parse common cron patterns to human-readable
      if (cron.match(/^\d+\s+\*\/(\d+)\s+\*\s+\*\s+\*/)) {
        const hours = cron.match(/\*\/(\d+)/)?.[1]
        refreshSchedule = hours === '1' ? 'hourly' : `every ${hours} hours`
      } else if (cron.match(/^\d+\s+\d+\s+\*\s+\*\s+\*/)) {
        refreshSchedule = 'daily'
      } else if (cron.match(/^\d+\s+\d+\s+\*\s+\*\s+\d+/)) {
        refreshSchedule = 'weekly'
      }
    }
  }
} catch (e) {
  // Fallback to default
}
---

<PageLayout meta={{ 
  title: `${notebookTitle} | ${project.name}`, 
  description: `Analysis notebook for ${project.name}` 
}}>
  <div class='flex w-full flex-col gap-y-8'>
    
    <Breadcrumbs items={[
      { label: 'Home', href: '/' },
      { label: 'Projects', href: '/projects' },
      { label: project.name, href: appUrl },
      { label: 'Analysis' }
    ]} />

    <!-- Header -->
    <header class='space-y-4'>
      <div class='flex items-start justify-between gap-4'>
        <div class='space-y-2'>
          <h1 class='text-2xl font-bold text-foreground sm:text-3xl'>{notebookTitle}</h1>
          <p class='max-w-2xl text-muted-foreground'>Analysis notebook for {project.name}</p>
        </div>
        
        <a
          href={githubNotebookUrl}
          target='_blank'
          rel='noopener noreferrer'
          class='flex shrink-0 items-center gap-2 rounded border border-border px-3 py-2 text-sm text-muted-foreground transition hover:border-foreground/30 hover:text-foreground'
        >
          <Icon name='mdi:github' class='h-4 w-4' />
          View Source
        </a>
      </div>
      
      {lastUpdated && (
        <div class='flex items-center gap-4 text-sm text-muted-foreground'>
          <span class='flex items-center gap-1.5'>
            <Icon name='mdi:calendar' class='h-4 w-4' />
            Last updated: {lastUpdated}
          </span>
          <span class='flex items-center gap-1.5'>
            <Icon name='mdi:refresh' class='h-4 w-4' />
            Refreshes {refreshSchedule}
          </span>
        </div>
      )}
    </header>

    <!-- Notebook Content -->
    {notebookExists ? (
      <div class='notebook-container overflow-hidden rounded-lg border border-border bg-card'>
        <Fragment set:html={notebookHtml} />
      </div>
    ) : (
      <div class='border border-dashed border-border p-8 text-center'>
        <Icon name='mdi:notebook-outline' class='mx-auto h-12 w-12 text-muted-foreground/50' />
        <h2 class='mt-4 text-lg font-medium text-foreground'>Analysis Coming Soon</h2>
        <p class='mt-2 text-muted-foreground'>
          This notebook will be generated on the next scheduled run (weekly).
        </p>
        <a
          href={githubNotebookUrl}
          target='_blank'
          rel='noopener noreferrer'
          class='mt-4 inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground'
        >
          <Icon name='mdi:github' class='h-4 w-4' />
          View source notebook on GitHub
        </a>
      </div>
    )}

    <!-- Back to Project -->
    <div class='border-t border-border pt-6'>
      <a
        href={appUrl}
        class='inline-flex items-center gap-2 text-muted-foreground transition hover:text-foreground'
      >
        ‚Üê Back to {project.name}
      </a>
    </div>

  </div>
</PageLayout>

<style>
  /* Style adjustments for embedded notebook */
  .notebook-container {
    padding: 2rem;
  }

  /* Override Jupyter notebook styles for better integration */
  .notebook-container :global(.jp-Notebook),
  .notebook-container :global(.jp-Cell) {
    background: transparent;
  }

  .notebook-container :global(img) {
    max-width: 100%;
    height: auto;
  }

  .notebook-container :global(table) {
    border-collapse: collapse;
    margin: 1rem 0;
  }

  .notebook-container :global(th),
  .notebook-container :global(td) {
    border: 1px solid #ddd;
    padding: 0.5rem;
    text-align: left;
  }

  .notebook-container :global(pre) {
    overflow-x: auto;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 4px;
  }

  /* ============================================ */
  /* DARK MODE - Comprehensive overrides         */
  /* ============================================ */

  /* Base text color for entire notebook */
  :global(.dark) .notebook-container,
  :global(.dark) .notebook-container :global(*) {
    color: #e0e0e0;
  }

  /* Markdown content - headings and text */
  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown),
  :global(.dark) .notebook-container :global(.jp-RenderedHTMLCommon) {
    color: #e0e0e0;
  }

  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown h1),
  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown h2),
  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown h3),
  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown h4),
  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown p),
  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown li),
  :global(.dark) .notebook-container :global(.jp-RenderedMarkdown strong) {
    color: #f0f0f0;
  }

  /* Code blocks and pre */
  :global(.dark) .notebook-container :global(pre) {
    background: #2d2d2d;
    color: #e0e0e0;
  }

  /* Output cells */
  :global(.dark) .notebook-container :global(.jp-OutputArea-output),
  :global(.dark) .notebook-container :global(.jp-RenderedText) {
    background: #2d2d2d;
    color: #e0e0e0;
  }

  /* Input prompts (In [1]:) */
  :global(.dark) .notebook-container :global(.jp-InputPrompt),
  :global(.dark) .notebook-container :global(.jp-OutputPrompt) {
    color: #888;
  }

  /* Tables */
  :global(.dark) .notebook-container :global(th),
  :global(.dark) .notebook-container :global(td) {
    border-color: #444;
    color: #e0e0e0;
  }

  /* Links */
  :global(.dark) .notebook-container :global(a) {
    color: #6db3f2;
  }

  /* Code syntax highlighting - preserve colors */
  :global(.dark) .notebook-container :global(.highlight) {
    background: #2d2d2d;
  }
</style>
