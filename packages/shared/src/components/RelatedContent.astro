---
/**
 * RelatedContent - Templatized section for app pages
 * Shows notebooks (Understand it) and Substack posts (Read about it)
 */
import NotebookSummary from './NotebookSummary.astro'
import SubstackPostPreview from './SubstackPostPreview.astro'
import { getNotebooksForProject } from '../lib/content-loader'
import { getSubstackPosts, getPostsByProject } from '../lib/substack'

// Import YAML mapping
import substackMappingsRaw from '../data/substack-posts.yaml?raw'

// Substack RSS URL (constant for this site)
const SUBSTACK_RSS_URL = 'https://theasymptotic.substack.com/feed'

interface Props {
  projectId: string
  projectName?: string  // Optional, kept for backwards compatibility
}

const { projectId } = Astro.props

// Load notebooks for this project (always available via public/analysis/)
const notebooks = getNotebooksForProject(projectId)

// Load Substack posts for this project
const allPosts = await getSubstackPosts(SUBSTACK_RSS_URL, substackMappingsRaw)
const projectPosts = getPostsByProject(allPosts, projectId)
---

<section class="related-content space-y-8">
  <!-- Understand it: Notebooks -->
  <div class="space-y-4">
    <div class="flex items-center gap-2">
      <span class="text-2xl">ðŸ“Š</span>
      <h2 class="text-2xl font-bold">Understand it</h2>
    </div>

    {notebooks.length > 0 ? (
      <div class="space-y-6">
        {notebooks.map(notebook => (
          <NotebookSummary
            projectId={projectId}
            notebookId={notebook.id}
            link={notebook.link}
          />
        ))}
      </div>
    ) : (
      <div class="rounded-lg border border-dashed border-border p-8 text-center">
        <div class="text-muted-foreground space-y-2">
          <p class="font-medium">No analysis notebooks yet</p>
          <p class="text-sm">
            ðŸ’¡ Create a Jupyter notebook in <code class="px-2 py-1 rounded bg-muted text-xs">analytics/notebooks/{projectId}/</code>
          </p>
          <p class="text-xs">
            It will automatically appear here when the CI/CD pipeline runs.
          </p>
        </div>
      </div>
    )}
  </div>

  <!-- Read about it: Posts -->
  <div class="space-y-4">
    <div class="flex items-center gap-2">
      <span class="text-2xl">ðŸ“®</span>
      <h2 class="text-2xl font-bold">Read about it</h2>
    </div>

    {projectPosts.length > 0 ? (
      <ul class="space-y-4 list-none p-0 m-0">
        {projectPosts.map(post => (
          <SubstackPostPreview post={post} withDesc />
        ))}
      </ul>
    ) : (
      <div class="rounded-lg border border-dashed border-border p-8 text-center">
        <div class="text-muted-foreground space-y-2">
          <p class="font-medium">No posts yet for this project</p>
          <p class="text-sm">
            Check the <a href={`/analysis?project=${projectId}`} class="font-semibold text-sky-600 hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300">Analysis page</a> for all writing.
          </p>
        </div>
      </div>
    )}
  </div>
</section>
