---
/**
 * NotebookSummary - Displays key findings from notebook YAML
 * Reads from public/analysis/{projectId}/{notebookId}.yaml
 *
 * Used by analysis pages to show experiment results at the top.
 */
import { Icon } from 'astro-icon/components'
import fs from 'node:fs'
import path from 'node:path'
import yaml from 'js-yaml'

/**
 * Find the monorepo root by looking for pnpm-workspace.yaml
 */
function findMonorepoRoot(): string {
  let dir = process.cwd()
  while (dir !== path.dirname(dir)) {
    if (fs.existsSync(path.join(dir, 'pnpm-workspace.yaml'))) {
      return dir
    }
    dir = path.dirname(dir)
  }
  return process.cwd()
}

interface Metric {
	label: string
	value: string
	delta?: string
	delta_direction?: 'up' | 'down' | 'neutral'
	context?: string
}

interface SummaryData {
	title: string
	status: 'significant' | 'not_significant' | 'inconclusive' | 'error'
	decision: string
	metrics: Metric[]
	power_analysis?: string
	warnings?: string[]
	methodology?: string
	generated_at?: string
}

interface Props {
	projectId: string
	notebookId: string
	link?: string  // Link to full notebook page
	class?: string
}

const { projectId, notebookId, link, class: className } = Astro.props

// Build link if not provided
const notebookLink = link || `/projects/${projectId}/analysis/${notebookId}/`

// Load YAML data at build time using fs
let data: SummaryData | null = null
let error: string | null = null

try {
	const root = findMonorepoRoot()
	const yamlPath = path.join(root, 'public', 'analysis', projectId, `${notebookId}.yaml`)
	if (fs.existsSync(yamlPath)) {
		const yamlContent = fs.readFileSync(yamlPath, 'utf-8')
		data = yaml.load(yamlContent) as SummaryData
	} else {
		error = `Summary not found: ${projectId}/${notebookId}.yaml`
	}
} catch (e) {
	error = `Error loading summary: ${e}`
}

// Status styling
const statusConfig = {
	significant: { icon: 'lucide:check-circle', color: 'text-green-600', bg: 'bg-green-50 dark:bg-green-950/30', label: 'Significant' },
	not_significant: { icon: 'lucide:minus-circle', color: 'text-amber-600', bg: 'bg-amber-50 dark:bg-amber-950/30', label: 'Not Significant' },
	inconclusive: { icon: 'lucide:help-circle', color: 'text-gray-600', bg: 'bg-gray-50 dark:bg-gray-800/50', label: 'Inconclusive' },
	error: { icon: 'lucide:alert-circle', color: 'text-red-600', bg: 'bg-red-50 dark:bg-red-950/30', label: 'Error' }
}

const status = data ? statusConfig[data.status] : null

// Count warnings for header display
const warningCount = data?.warnings?.length || 0

// Delta arrow helper
const deltaIcon = (dir?: string) => {
	if (dir === 'up') return 'lucide:trending-up'
	if (dir === 'down') return 'lucide:trending-down'
	return 'lucide:minus'
}

const deltaColor = (dir?: string) => {
	if (dir === 'up') return 'text-green-600'
	if (dir === 'down') return 'text-red-600'
	return 'text-gray-500'
}

// Format timestamp as full datetime
const formatTimestamp = (isoString?: string) => {
	if (!isoString) return ''
	const date = new Date(isoString)
	return date.toLocaleString('en-US', {
		year: 'numeric',
		month: 'short',
		day: 'numeric',
		hour: '2-digit',
		minute: '2-digit'
	})
}
---

{error ? (
	<div class={`border border-dashed border-border rounded-lg p-4 text-muted-foreground text-sm ${className || ''}`}>
		{error}
	</div>
) : data && status && (
	<div class={`border border-border rounded-lg overflow-hidden ${className || ''}`}>
		{/* Header with status */}
		<div class={`px-5 py-4 border-b border-border ${status.bg}`}>
			<div class='flex items-center justify-between gap-4 flex-wrap'>
				<div class='flex items-center gap-3'>
					<Icon name={status.icon} class={`h-6 w-6 ${status.color}`} />
					<div>
						<h3 class='font-semibold text-foreground'>{data.title}</h3>
						<span class='text-sm'>
							<span class={`font-medium ${status.color}`}>{status.label}</span>
							{warningCount > 0 ? (
								<span class='text-amber-600 dark:text-amber-400'> — {warningCount} warning{warningCount > 1 ? 's' : ''} below</span>
							) : (
								<span class='text-muted-foreground'> — no warnings</span>
							)}
						</span>
					</div>
				</div>
				<div class='flex items-center gap-4'>
					{data.generated_at && (
						<span class='text-xs text-muted-foreground hidden sm:inline'>
							Updated: {formatTimestamp(data.generated_at)}
						</span>
					)}
					<a
						href={notebookLink}
						class='inline-flex items-center gap-1.5 rounded-md bg-foreground px-3 py-1.5 text-sm font-medium text-background transition-colors hover:bg-foreground/90'
					>
						View Notebook
						<Icon name='lucide:arrow-right' class='h-4 w-4' />
					</a>
				</div>
			</div>
		</div>

		{/* Decision callout */}
		<div class='px-5 py-4 bg-muted/30 border-b border-border'>
			<p class='text-foreground'>
				<span class='font-semibold'>Decision:</span> {data.decision}
			</p>
		</div>

		{/* Metrics grid */}
		{data.metrics.length > 0 && (
			<div class='px-5 py-4 grid grid-cols-2 md:grid-cols-4 gap-4'>
				{data.metrics.map((metric) => (
					<div class='space-y-1'>
						<p class='text-xs text-muted-foreground uppercase tracking-wide'>{metric.label}</p>
						<div class='flex items-baseline gap-2'>
							<span class='text-xl font-semibold text-foreground'>{metric.value}</span>
							{metric.delta && (
								<span class={`flex items-center gap-0.5 text-sm ${deltaColor(metric.delta_direction)}`}>
									<Icon name={deltaIcon(metric.delta_direction)} class='h-3 w-3' />
									{metric.delta}
								</span>
							)}
						</div>
						{metric.context && (
							<p class='text-xs text-muted-foreground'>{metric.context}</p>
						)}
					</div>
				))}
			</div>
		)}

		{/* Warnings */}
		{data.warnings && data.warnings.length > 0 && (
			<div class='px-5 py-3 border-t border-border bg-amber-50/50 dark:bg-amber-950/20 space-y-1'>
				{data.warnings.map((warning) => (
					<div class='flex items-start gap-2 text-sm text-amber-700 dark:text-amber-400'>
						<Icon name='lucide:alert-triangle' class='h-4 w-4 mt-0.5 shrink-0' />
						<span>{warning}</span>
					</div>
				))}
			</div>
		)}

		{/* Methodology footer */}
		{data.methodology && (
			<div class='px-5 py-2 border-t border-border bg-muted/10 text-xs text-muted-foreground'>
				<span class='font-medium'>Methodology:</span> {data.methodology}
			</div>
		)}
	</div>
)}
